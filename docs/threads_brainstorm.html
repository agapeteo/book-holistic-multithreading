<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Brainstorm - Holistic multithreading</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="this_book.html"><strong aria-hidden="true">1.1.</strong> How this book is different</a></li><li class="chapter-item expanded "><a href="why.html"><strong aria-hidden="true">1.2.</strong> Why multithreading is important</a></li><li class="chapter-item expanded "><a href="history.html"><strong aria-hidden="true">1.3.</strong> A brief history of thread</a></li></ol></li><li class="chapter-item expanded "><a href="languages.html"><strong aria-hidden="true">2.</strong> Concurrency and multithreading in practical languages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="java.html"><strong aria-hidden="true">2.1.</strong> Java</a></li><li class="chapter-item expanded "><a href="c.html"><strong aria-hidden="true">2.2.</strong> C</a></li><li class="chapter-item expanded "><a href="c++.html"><strong aria-hidden="true">2.3.</strong> C++</a></li><li class="chapter-item expanded "><a href="rust.html"><strong aria-hidden="true">2.4.</strong> Rust</a></li><li class="chapter-item expanded "><a href="golang.html"><strong aria-hidden="true">2.5.</strong> Go</a></li><li class="chapter-item expanded "><a href="python.html"><strong aria-hidden="true">2.6.</strong> Python</a></li><li class="chapter-item expanded "><a href="javascript.html"><strong aria-hidden="true">2.7.</strong> JavaScript</a></li></ol></li><li class="chapter-item expanded "><a href="threads_under_the_hood.html"><strong aria-hidden="true">3.</strong> Threads under the hood</a></li><li class="chapter-item expanded "><a href="critical_section.html"><strong aria-hidden="true">4.</strong> Critical section</a></li><li class="chapter-item expanded "><a href="atomics.html"><strong aria-hidden="true">5.</strong> Atimics and memory fences</a></li><li class="chapter-item expanded "><a href="communication.html"><strong aria-hidden="true">6.</strong> Thread communication</a></li><li class="chapter-item expanded "><a href="deadlocks.html"><strong aria-hidden="true">7.</strong> Deadlocks and live locks</a></li><li class="chapter-item expanded "><a href="coroutines.html"><strong aria-hidden="true">8.</strong> Coroutines and async programming</a></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">9.</strong> Debugging and testing</a></li><li class="chapter-item expanded "><a href="best_practices.html"><strong aria-hidden="true">10.</strong> Best practices</a></li><li class="chapter-item expanded "><a href="threads_brainstorm.html" class="active"><strong aria-hidden="true">11.</strong> Brainstorm</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Holistic multithreading</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="threads-under-the-hood-brainstorming"><a class="header" href="#threads-under-the-hood-brainstorming">Threads under the hood brainstorming</a></h1>
<h2 id="why-multithreading"><a class="header" href="#why-multithreading">Why multithreading</a></h2>
<ul>
<li>
<p>why are you reading this book?</p>
</li>
<li>
<p>fill in knowledge gap</p>
</li>
<li>
<p>write apps more perfomant and efficient.</p>
</li>
</ul>
<p>Fortunately, you're not alone or first....</p>
<p>History starting from task and hardware.</p>
<p>Then new layers appeared, like languages, OS.</p>
<p>But still need to solve stalls. New parallelism, but new problems like deadlocks etc.
Languages chose different approaches: some limit access to multithreading facilities while others avoid altogether.
Concurrent languages that are not parallel (Python, JS) vs concurrent languages that are parallel.
So some languages avoid deadlocks by completely avoiding parallel execution. Python and friends lack granular access control to shared state.</p>
<p>Even thread as a term does not describe the nature of the abstraction. Other terminology is awkward to say the least (like lock-free algorithms that are not lock free).
Parallel, concurrent, async, coroutines, and non-blocking - people don't really understand the terms. Most regard them as synonyms.
Hard to imagine what a coroutine means. What the heck is continuation? We will try to disentangle all of these for you using as simple terms as possible (illustrate with figures).
Stackless coroutines - why are they stackless. And other confusing terms.</p>
<p>We will use the Pareto principle - i.e. we will explain the things that are used the most in greater detail. </p>
<p>Formal multithreading by Dijkstra and gang.</p>
<p>Same hardware improvement, but hardware limits. + Moore's law</p>
<p>Complexity dilema with 2 ways: not efficient, or learn multithreading.</p>
<p>We prefer second option.</p>
<p>Electricity analogy: it can kill you if you're careless or it can do a lot of wonderful things if you know how to use it.</p>
<p>So what is thread? Abstraction and potentially leaky abstraction.</p>
<p>Review of abstraction level in theory and then in practice.</p>
<hr />
<p>Your program is thread-safe when it has no shared state, but in this case it is unlikely to use hardware in the most efficient way.</p>
<hr />
<p>History of computing through the lens of efficiency. From early operation systems to present day. You can use threads to use CPU efficiently.
We can either create efficient software or keep wasting money on suboptimal algorithms. The choice is yours. You can safe the world from the farting cows and AOC.
When we talk about history we talk about hardware, OS, and programming languages, how they evolved together and influenced one another.</p>
<p>TODO: insert a graph of energy use by language.</p>
<h2 id="applications-languages-processes-and-threads"><a class="header" href="#applications-languages-processes-and-threads">Applications, languages, processes, and threads</a></h2>
<ul>
<li>what is application, </li>
<li>group of tasks that help to archive some goal</li>
<li>application can run one or more processes on a single or multiple computers. </li>
</ul>
<p>TODO languages and code
Application -&gt; tasks -&gt; algorithms &amp; data structures -&gt; code -&gt; languages</p>
<p>Applications consist of structure or sequence of tasks. Tasks are solved by applying algorithms to data structures.
Algorithms and data structures are represented with programming languages, which translate human concepts into binary machine code of specific hardware.
As you have probably noticed, we've described a chain of abstractions. Let's make a brief detour and discuss what is an abstraction.
Abstraction is notion that separates something generic (general) from specific. Why would we need that?
It helps us recognize and apply patterns to a group of notions while ignoring unrelated details. When some details become relevant, an abstraction becomes leaky.
We have noticed that threads are often described with leaky abstractions. They can work at some level of analysis, but inevitably break down...</p>
<p>So to understand threads we need holistic approach. What do we mean by that? An approach that weaves together a problem itself, architecture,
data structures and algorithms, a language, a compiler, an operating system, system calls, assembly language, and even specifics of hardware in a comprehensive whole picture.</p>
<h3 id="a-problem"><a class="header" href="#a-problem">A problem</a></h3>
<p>Importance of separating of what to do from how to do it. Don't mix it up. Resist is someone is trying to tell you how to do something instead of telling what needs to be done.
In other words, you should always understand what you are trying to achieve before you start thinking about the particular ways to achieve it.
Requirements: business, functional, non-functional (SLA, throughput, latency, real-time, performance).</p>
<h3 id="architecture"><a class="header" href="#architecture">Architecture</a></h3>
<p>We need to understand high-level components of the system and their interactions without focusing on specifics of implementation. This is when we start considering
some components as separate parallel nodes, processes, or threads. </p>
<h3 id="algorithms-and-data-structures"><a class="header" href="#algorithms-and-data-structures">Algorithms and Data Structures</a></h3>
<p>This is the layer where specifics of multithreading starts to emerge.</p>
<h3 id="languages"><a class="header" href="#languages">Languages</a></h3>
<p>Every language has a specific niche, and although they may overlap, some languages are better suited to your problem than others.
You also have to take into account the developer's background, organizational restrictions, and existing standards and infrastructure.
We are going to be focusing mostly on parallel languages like Java, C++, Rust, and Go, rather than just concurrent languages like JS, Python.
Parallel vs concurrent - concurrency is a property of code, while parallelism is a property of an execution model.
The authors maintain that in most cases readability tops speed of writing code (we talk about verbosity of languages in some sense - Python is less verbose than Java,
but Java is more readable).</p>
<h3 id="compiler"><a class="header" href="#compiler">Compiler</a></h3>
<p>Compilers translate the human-readable code of the program into machine code in the most efficient way because it generates code optimized for specific hardware.
It can also reorder instructions to optimize performance, which has its implications for multithreading.</p>
<h3 id="operating-system"><a class="header" href="#operating-system">Operating system</a></h3>
<p>Most important part of the OS is its kernel, which manages access to the shared hardware. System calls - what vs how we do it. If we have system calls,
we don't care about the particular implementation of the OS (where stable system calls are available).
The concept of thread only exists within the OS. Threads are made possible by a scheduler and virtual memory. If you don't have an OS, you can still have threads, but you would
have to at least implement your own scheduler and that's half way to OS itself.</p>
<p>Each thread has its own stack. How a thread differs from a process. Preemptive vs cooperative scheduling. Mapping software to hardware threads.
TODO: Process memory segments. Thread vs process.</p>
<h3 id="assembly-language"><a class="header" href="#assembly-language">Assembly language</a></h3>
<p>Human readable version of machine code. You rarely need to write it but you have to know how to read it because it's a great way to understand what the CPU is actually doing.</p>
<h3 id="cpu"><a class="header" href="#cpu">CPU</a></h3>
<p>ISA vs hardware architecture. Clock rate. Accessing memory takes centuries, so we need caches. CPUs are optimized for single-threaded execution.
Branch prediction, speculation, pipelining.</p>
<p>First we need to understand how to solve the problem: which tools are available, which ones are best suited for it, restrictions, infrastructure.</p>
<h2 id="why-use-threads"><a class="header" href="#why-use-threads">Why use threads?</a></h2>
<ul>
<li>
<p>speed and efficiency</p>
</li>
<li>
<p>Moore's law</p>
</li>
<li>
<p>why clock rate is not growing that fast</p>
</li>
<li>
<p>cost</p>
</li>
<li>
<p>heat and power consumption</p>
</li>
<li>
<p>Amdahl's law</p>
</li>
</ul>
<h2 id="thread-history"><a class="header" href="#thread-history">Thread history</a></h2>
<p>3 original authors. 
from multiprogramming operating systems to multithreaded applications</p>
<p>Operating systems are about effectively running applications on the given hardware.
Effectively could also mean
?? what is OS
That's why operating system may represent application as a runing process. 
OS limits what process can do, but in returns it gives greater flexibility and effency overall.</p>
<p>Process is the means by which Operating Systems runs application.
Stricktly speaking, Operation System is not mandatory to run multiple processes. For example in amberdded hardware.
But you still need to schedule processes somehow, so you need at least a scheduler to manage multiple processes.</p>
<p>Creating a process is complex task that includes:</p>
<ul>
<li>finding and allocting memory</li>
<li>etc.. TODO</li>
<li>TODO</li>
</ul>
<p>it's not even an exhastive list</p>
<p>But there is another OS abtraction that can significantly simplify the way we can execute code on a given cpu - 
THREADS
T
THREADS ARE</p>
<p>-- responsibility OS</p>
<p>safety
resources 
memory</p>
<p>memory types
code - data</p>
<p>stack
memory segments</p>
<p>Each thread own stack, registers, but everyhting else is shared</p>
<p>compiled application format for OS - ELF, ...</p>
<p>preemtive, cooperative</p>
<p>OS CPU allocation </p>
<p>--- hardware --</p>
<p>cpu structure</p>
<p>ISA &amp; mictoarchitecture separation</p>
<p>slow memory</p>
<p>code reordering</p>
<hr />
<p>example</p>
<p>Java thread withot join, with join
bytecote -&gt; JVM -&gt; clib, pthread -&gt; ELF </p>
<p>C example with phread
C++ woth thread -&gt; pthread, glibc or musl, nptl, ....</p>
<p>Go and friends</p>
<p>RUST</p>
<p>strace CLONE, FUTEX</p>
<p>?? pthread cancellation </p>
<p>assembly snippet</p>
<hr />
<p>--- THREAD anaylogy probably with baristas</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="best_practices.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="best_practices.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
